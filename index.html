<!DOCTYPE html>
<html>
<head>
    <title>Dungeoneering Tracker</title>
    <script src="https://alt1.toolkit.runescape.com/alt1lib.js"></script>
    window.alt1 && alt1.identifyApp("dungtracker", "Dungeoneering Tracker");
    <script>
        if (!window.alt1) alt1 = window.alt1;
        if (!alt1) alert("Alt1 is not detected. This plugin must be run within Alt1 Toolkit.");
alt1.identifyApp("dungtracker", "Dungeoneering Tracker");
alt1.setOverlayApp(true);
        const overlay = new Overlay("dung-tracker", 350, 260);
        let floorStartTime = null;
        let floorNumber = null;
        let floorXp = 0;
        let tokensEarned = 0;
        let totalFloorsCompleted = 0;
        let sessionLog = [];

        function startFloor(floor) {
            floorStartTime = Date.now();
            floorNumber = floor;
            floorXp = 0;
            tokensEarned = 0;
            renderOverlay();
        }

        function endFloor(xp, tokens) {
            const elapsedTime = ((Date.now() - floorStartTime) / 1000).toFixed(0);
            floorXp = xp;
            tokensEarned = tokens;
            totalFloorsCompleted++;
            sessionLog.push({
                floor: floorNumber,
                time: elapsedTime,
                xp: xp,
                tokens: tokens
            });
            renderOverlay(elapsedTime);
        }

        function renderOverlay(elapsedTime = null) {
            const container = document.getElementById("overlay.container");
            const latest = sessionLog[sessionLog.length - 1] || {};
            container.innerHTML = `
                <div style="background-color: rgba(0,0,0,0.85); color: white; padding: 10px; font-family: sans-serif;">
                    <h2 style="margin: 0 0 10px 0;">üè∞ Dungeoneering Tracker</h2>
                    <p>Floor: <strong>${floorNumber || "--"}</strong></p>
                    <p>Time: <strong>${elapsedTime ? formatTime(elapsedTime) : (floorStartTime ? "Running..." : "--")}</strong></p>
                    <p>XP Gained: <strong>${floorXp.toLocaleString()}</strong></p>
                    <p>XP/Hour: <strong>${floorXp > 0 && elapsedTime ? calcXpPerHour(floorXp, elapsedTime) : "--"}</strong></p>
                    <p>Tokens: <strong>${tokensEarned}</strong></p>
                    <p>Floors Completed: <strong>${totalFloorsCompleted}</strong></p>
                    <hr style="margin: 8px 0;">
                    <p><strong>Last Floor:</strong> ${latest.floor || "--"} | XP: ${latest.xp?.toLocaleString() || 0} | Time: ${formatTime(latest.time || 0)}</p>
                    <div style="display:flex; gap:8px; margin-top:10px;">
                      <button onclick="manualMarkComplete()">‚úîÔ∏è Mark Floor</button>
                      <button onclick="resetTracker()">üîÅ Reset</button>
                      <button onclick="exportLog()">üì§ Export</button>
                    </div>
                </div>
            `;
        }

        function formatTime(seconds) {
            seconds = parseInt(seconds);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return \`\${mins}:\${secs < 10 ? '0' : ''}\${secs}\`;
        }

        function calcXpPerHour(xp, seconds) {
            const rate = (xp / seconds) * 3600;
            return parseInt(rate).toLocaleString();
        }

        function manualMarkComplete() {
            const xp = parseInt(prompt("Enter XP gained this floor:"), 10);
            const tokens = parseInt(prompt("Enter tokens earned this floor:"), 10);
            const floor = parseInt(prompt("What floor number did you just complete?"), 10);
            if (!isNaN(xp) && !isNaN(tokens) && !isNaN(floor)) {
                floorNumber = floor;
                endFloor(xp, tokens);
            } else {
                alert("Invalid input. Please enter numerical values only.");
            }
        }

        function resetTracker() {
            if (!confirm("Reset all tracking data for this session?")) return;
            floorStartTime = null;
            floorNumber = null;
            floorXp = 0;
            tokensEarned = 0;
            totalFloorsCompleted = 0;
            sessionLog = [];
            renderOverlay();
        }

        function exportLog() {
            let logText = "Floor,Xp,Tokens,Time\n";
            sessionLog.forEach(entry => {
                logText += \`\${entry.floor},\${entry.xp},\${entry.tokens},\${formatTime(entry.time)}\n\`;
            });
            const blob = new Blob([logText], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dungeoneering_log.csv';
            a.click();
        }

        renderOverlay();
    </script>
</head>
<body>
  <div id="overlay-container"></div>  
</body>
</html>
